# 调试环境配置

## 概述

配置一个良好的调试环境是深入学习 React 源码的关键。本章将详细介绍如何搭建完整的 React 源码调试环境。

## 环境要求

### 系统要求

- **Node.js**: 16.0+ 
- **包管理器**: pnpm (推荐) 或 npm
- **编辑器**: VS Code (推荐)
- **浏览器**: Chrome/Edge (支持 DevTools)

### 必要工具

```bash
# 安装 pnpm
npm install -g pnpm

# 安装 VS Code 扩展
# - JavaScript Debugger
# - React Developer Tools
# - ES6 String HTML
```

## 项目结构说明

我们的调试环境基于以下结构：

```
dive-react-19/
├── packages/
│   ├── react-dojo/           # 调试实践环境
│   │   ├── source-code/      # React 源码
│   │   │   └── react/        # 完整的 React 仓库
│   │   ├── dojo/             # 我们的实践代码
│   │   ├── webpack.config.js # 构建配置
│   │   └── package.json
│   └── rspress-site/         # 文档站点
└── CLAUDE.md                 # 项目说明
```

## 核心配置详解

### Webpack 别名配置

这是调试环境的核心配置，它将 React 包指向本地源码：

```javascript
// packages/react-dojo/webpack.config.js
module.exports = {
  resolve: {
    alias: {
      // 将 react 包指向本地源码
      react: path.resolve(__dirname, "./source-code/react/packages/react"),
      "react-dom": path.resolve(__dirname, "./source-code/react/packages/react-dom"),
      "react-reconciler": path.resolve(__dirname, "./source-code/react/packages/react-reconciler"),
      scheduler: path.resolve(__dirname, "./source-code/react/packages/scheduler"),
      shared: path.resolve(__dirname, "./source-code/react/packages/shared"),
    },
  },
  // 开启 source map 支持
  devtool: "cheap-module-source-map",
  // 其他配置...
};
```

### 关键特性

1. **完整源码映射**：直接调试 React 源码，不是构建后的版本
2. **开发环境标志**：启用所有开发时的警告和检查
3. **热重载支持**：代码修改后自动刷新

## 启动调试环境

### 1. 克隆并安装依赖

```bash
# 克隆项目
git clone [repository-url]
cd dive-react-19

# 安装依赖
pnpm install
```

### 2. 启动调试服务器

```bash
# 启动 React 调试环境（端口 8080）
pnpm react:dev

# 或者进入 react-dojo 目录
cd packages/react-dojo
pnpm dev
```

### 3. 打开浏览器调试

访问 `http://localhost:8080`，打开浏览器开发者工具。

## 调试技巧

### 1. 在源码中设置断点

```javascript
// packages/react-dojo/dojo/index.jsx
import { useState } from 'react';

function App() {
  const [count, setCount] = useState(0);
  
  // 在这里设置断点，然后单步调试进入 useState 源码
  debugger;
  
  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>
        增加
      </button>
    </div>
  );
}

export default App;
```

### 2. 源码断点位置推荐

#### React 入口点

```javascript
// source-code/react/packages/react/src/React.js
export {
  useState,
  useEffect,
  // ... 在这些导出处设置断点
} from './ReactHooks';
```

#### useState 实现

```javascript
// source-code/react/packages/react-reconciler/src/ReactFiberHooks.js
function useState(initialState) {
  debugger; // 在这里观察 Hook 的实现
  return useReducer(basicStateReducer, initialState);
}
```

#### 渲染流程

```javascript
// source-code/react/packages/react-reconciler/src/ReactFiberWorkLoop.js
function workLoopSync() {
  while (workInProgress !== null) {
    debugger; // 观察 Fiber 树的构建过程
    performUnitOfWork(workInProgress);
  }
}
```

### 3. 使用 React DevTools

安装 React DevTools 浏览器扩展：

1. **组件面板**：查看组件树和 Props
2. **Profiler 面板**：分析组件渲染性能
3. **设置面板**：启用额外的调试功能

配置 DevTools 以支持源码调试：

```javascript
// 在应用入口添加
if (typeof window !== 'undefined' && window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
  window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.appendComponentStack = true;
}
```

## VS Code 调试配置

### 1. 创建调试配置

创建 `.vscode/launch.json`：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug React App",
      "type": "node",
      "request": "launch",
      "cwd": "${workspaceFolder}/packages/react-dojo",
      "runtimeExecutable": "pnpm",
      "runtimeArgs": ["dev"],
      "serverReadyAction": {
        "pattern": "webpack compiled|Local:.*?(https?://.*?/)",
        "uriFormat": "%s",
        "action": "debugWithChrome"
      }
    }
  ]
}
```

### 2. 设置断点

在 VS Code 中直接在源码文件中点击行号设置断点：

- React 源码文件：`source-code/react/packages/`
- 我们的代码：`dojo/index.jsx`

## 常用调试场景

### 1. 调试 Hook 机制

```javascript
// dojo/index.jsx
function HookDebugComponent() {
  // 设置断点，观察 Hook 链表的构建
  const [state1, setState1] = useState(1);
  const [state2, setState2] = useState(2);
  
  useEffect(() => {
    // 观察 Effect Hook 的执行
    console.log('Effect executed');
  }, [state1]);
  
  return (
    <div>
      <button onClick={() => setState1(state1 + 1)}>
        State 1: {state1}
      </button>
      <button onClick={() => setState2(state2 + 1)}>
        State 2: {state2}
      </button>
    </div>
  );
}
```

### 2. 调试渲染过程

```javascript
// dojo/index.jsx
function RenderDebugComponent() {
  const [list, setList] = useState([1, 2, 3]);
  
  return (
    <div>
      {/* 观察列表更新时的 Diff 算法 */}
      {list.map(item => (
        <div key={item}>Item {item}</div>
      ))}
      <button onClick={() => setList([...list, list.length + 1])}>
        添加项目
      </button>
      <button onClick={() => setList(list.slice(0, -1))}>
        删除项目
      </button>
    </div>
  );
}
```

### 3. 调试事件系统

```javascript
// dojo/index.jsx
function EventDebugComponent() {
  const handleClick = (e) => {
    // 观察合成事件的处理过程
    debugger;
    console.log('合成事件:', e);
    console.log('原生事件:', e.nativeEvent);
  };
  
  return (
    <div onClick={handleClick}>
      <button onClick={handleClick}>
        点击测试事件
      </button>
    </div>
  );
}
```

## 调试最佳实践

### 1. 调试前的准备

- **了解调试目标**：明确想要了解的功能点
- **准备测试用例**：编写能触发特定行为的代码
- **熟悉源码结构**：了解相关功能在源码中的位置

### 2. 调试过程中

- **逐步执行**：使用 Step Into 深入函数调用
- **观察变量**：重点关注 Fiber、Hook、Lane 等关键数据结构
- **记录发现**：将重要发现记录在文档中

### 3. 调试后的总结

- **理解流程**：梳理完整的执行流程
- **绘制图表**：用流程图或时序图记录理解
- **验证理解**：通过修改代码验证理解是否正确

## 常见问题解决

### 1. 源码映射不工作

```bash
# 检查 webpack 配置
# 确保 devtool 设置正确
devtool: "cheap-module-source-map"

# 检查别名配置
# 确保路径指向正确的源码目录
```

### 2. 断点不生效

- 确保在 Sources 面板中能看到源码文件
- 检查文件路径是否正确
- 尝试在 Chrome DevTools 中手动设置断点

### 3. 性能问题

```javascript
// 关闭不需要的开发特性
const webpack = require('webpack');

module.exports = {
  plugins: [
    new webpack.DefinePlugin({
      __DEV__: true,
      __EXPERIMENTAL__: false, // 关闭实验特性
      __PROFILE__: false,      // 关闭性能分析
    }),
  ],
};
```

## 总结

通过以上配置，我们建立了一个完整的 React 源码调试环境：

1. **完整的源码访问**：可以直接调试 React 源码
2. **强大的调试工具**：VS Code + Chrome DevTools + React DevTools
3. **灵活的测试环境**：可以快速编写和测试各种场景
4. **详细的调试指南**：涵盖各种常见调试场景

这个环境将为我们深入学习 React 源码提供强有力的支持。