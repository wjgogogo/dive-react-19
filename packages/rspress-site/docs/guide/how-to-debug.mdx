# 如何调试 React 源码？

## 准备工作

- Node.js ≥ 18，建议使用 LTS 版本。
- 包管理器使用 pnpm（已在仓库配置）。
- 可选：VSCode（便于断点与浏览器调试）。

## 最简单的方式

克隆本仓库：

```bash
git clone https://github.com/wjgogogo/dive-react-19.git
```

安装依赖：

```bash
pnpm install
```

执行命令，启动 React 源码调试：

```bash
pnpm react:dev
```

也可以在 `packages/react-dojo/dojo/index.jsx` 中追加/修改用例进行验证。

一条命令快速启动：

```bash
pnpm install && pnpm react:dev
```

![](/debug.png)

若使用 VSCode，在启动项目后到「运行和调试」面板选择「启动 react debug」即可对源码断点调试（已在 .vscode/launch.json 配置）。

![](/debug-vscode.png)

:::tip
本仓库使用的是 React v19.2.0 版本，对应的 tag 为 [v19.2.0](https://github.com/facebook/react/tree/v19.2.0)。
:::

## 使用 Webpack 调试 React 源码

如果你想调试 React 最新版代码，实时跟踪 React 进展，也可以采用与本仓库相同的思路搭建最小可复现环境。关键步骤如下。

新建项目，假设项目名为 `react-debug`。

### 克隆 React 最新版代码

在 `react-debug` 项目根目录下，执行命令获取 React 最新版代码：

```bash
git clone https://github.com/facebook/react.git --branch v19.2.0 --depth 1
```

### webpack 配置

假设项目结构为：

```bash
react-debug
├── src
│   └── index.jsx # 调试代码
├── react # react 源码项目
├── webpack.config.js # webpack 配置
├── public
│   └── index.html
├── package.json
```

`package.json` 配置如下（版本与本仓库保持一致或取其同等兼容范围）：

```json
{
  "scripts": {
    "dev": "cross-env NODE_ENV=development webpack serve"
  },
  "devDependencies": {
    "@babel/preset-env": "^7.26.0",
    "@babel/preset-flow": "^7.24.7",
    "@babel/preset-react": "^7.24.7",
    "babel-loader": "^9.1.3",
    "cross-env": "^7.0.3",
    "css-loader": "^6.10.0",
    "html-webpack-plugin": "^5.6.0",
    "source-map-loader": "^5.0.0",
    "style-loader": "^3.3.4",
    "webpack": "^5.90.3",
    "webpack-cli": "^5.1.4",
    "webpack-dev-server": "^5.0.2"
  }
}
```

`webpack.config.js` 配置如下（通过 alias 将 `react/*` 映射到源码包目录；并定义 React 源码中使用的全局常量）：

```js
const path = require("path");
const HtmlWebpackPlugin = require("html-webpack-plugin");
const webpack = require("webpack");

module.exports = {
  mode: "development",
  devtool: "cheap-module-source-map",
  entry: "./src/index.jsx",
  // !callout[/resolve/] 将 react 解析定位到源码文件
  resolve: {
    // !className(1:15) border-2! border-blue-300! rounded-sm
    alias: {
      react: path.resolve(__dirname, "./react/packages/react"),
      "react-client": path.resolve(__dirname, "./react/packages/react-client"),
      "react-dom": path.resolve(__dirname, "./react/packages/react-dom"),
      "react-dom-bindings": path.resolve(
        __dirname,
        "./react/packages/react-dom-bindings"
      ),
      "react-reconciler": path.resolve(
        __dirname,
        "./react/packages/react-reconciler"
      ),
      scheduler: path.resolve(__dirname, "./react/packages/scheduler"),
      shared: path.resolve(__dirname, "./react/packages/shared")
    }
  },
  module: {
    rules: [
      {
        enforce: "pre",
        // !callout[/exclude/] 映射 babel 编译的代码的 source map
        exclude: /@babel(?:\/|\\{1,2})runtime/,
        test: /\.(js|mjs|jsx|css)$/,
        loader: "source-map-loader"
      },
      {
        test: /\.(js|mjs|jsx)$/,
        loader: "babel-loader",
        options: {
          presets: [
            [
              "@babel/preset-env",
              {
                // 针对现代浏览器，减少不必要的转换
                targets: {
                  browsers: ["last 2 Chrome versions"]
                }
              }
            ],
            [
              "@babel/preset-react",
              {
                development: true,
                runtime: "automatic"
              }
            ],
            // !callout[/\[.*?\]/] react 源码使用 flow 语法，需要 flow 插件编译
            ["@babel/preset-flow"]
          ]
        }
      },
      {
        test: /\.css$/,
        use: ["style-loader", "css-loader"],
        sideEffects: true
      }
    ]
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: path.resolve(__dirname, "./public/index.html")
    }),
    // !callout[/DefinePlugin/] react 源码中所使用的全局变量
    new webpack.DefinePlugin({
      "process.env.NODE_ENV": JSON.stringify("development"),
      // !mark(1:3)
      __DEV__: true, // 用于区分开发环境和生成环境
      __EXPERIMENTAL__: false, // 若需体验实验特性，可改为 true（可能引入不稳定改动）
      __PROFILE__: false // 是 React 源码中用于性能分析的全局标志，主要用于控制与性能分析相关的功能是否启用
    })
  ],
  devServer: {
    static: {
      directory: path.resolve(__dirname, "public")
    },
    port: 8080,
    hot: false,
    client: {
      progress: true,
      overlay: false
    }
  }
};
```

`public/index.html` 就是最常规的模板内容：

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>React App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>
```

### 源码修改

React 在编译时才会提供 renderer。为聚焦 CSR，可跳过脚本分发逻辑，直接指向 `ReactFiberConfig.dom`：

```js title="react/packages/react-reconciler/src/ReactFiberConfig.js"
// We expect that our Rollup, Jest, and Flow configurations
// always shim this module with the corresponding host config
// (either provided by a renderer, or a generic shim for npm).
//
// We should never resolve to this file, but it exists to make
// sure that if we *do* accidentally break the configuration,
// the failure isn't silent.

// !diff -
// throw new Error('This module must be shimmed by a specific renderer.');
// !diff +
export * from "./forks/ReactFiberConfig.dom";
```

`log` 和 `unstable_setDisableYieldValue` 函数仅在测试环境存在，这里置为空避免引用错误：

```js title="react/packages/react-reconciler/src/Scheduler.js"
// this doesn't actually exist on the scheduler, but it *does*
// on scheduler/unstable_mock, which we'll need for internal testing
// !diff -
// export const log = Scheduler.log;
// !diff -
// export const unstable_setDisableYieldValue = Scheduler.unstable_setDisableYieldValue;
// !diff +
export const log = () => {};
// !diff +
export const unstable_setDisableYieldValue = () => {};
```

React 使用 `ReactSharedInternals` 共享内部功能与状态，Client/Server 各有实现，这里固定为 Client 版本：

```js title="react/packages/shared/ReactSharedInternals.js"
// !diff -
// import * as React from 'react';
// !diff -
// const ReactSharedInternals = React.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;
// !diff +
import ReactSharedInternals from "../react/src/ReactSharedInternalsClient";
// !diff +
export default ReactSharedInternals;
```

### 处理 Flow 语法兼容性

React 19.2.0 源码使用了新的 Flow 语法特性（如 `component()` 类型），当前 @babel/parser 暂不支持。需要做以下处理：

**1. 修改 ReactFiberDevToolsHook.js**

```js title="react/packages/react-reconciler/src/ReactFiberDevToolsHook.js"
// 将 const 改为 var
declare var __REACT_DEVTOOLS_GLOBAL_HOOK__: Object | void;
```

**2. 修改 isArray.js**

```js title="react/packages/shared/isArray.js"
// 注释掉不支持的类型谓词语法
// declare function isArray<T>(
//   v: T,
// ): v is T extends $ReadOnlyArray<mixed> ? T : empty;
```

**3. 批量替换新 Flow 语法**

在 `react` 目录下执行：

```bash
find . -type f \( -name "*.js" -o -name "*.jsx" \) \
  -not -path "*/__tests__/*" \
  -exec perl -i -pe 's/component\(\.\.\.props:\s*any\)/any/g; s/:\s*(\d+|true|false|null)\s+as\s+\w+/: $1/g; s/component\(\)/Function/g' {} \;
```

此命令会替换 `component()` 类型声明和类型断言语法，排除测试文件。

最后执行命令：

```bash
pnpm dev # or npm run dev
```

![](/dev.png)

:::info
React 最新源码变动频繁，即使完成上述操作也不保证一次通过。请根据报错栈定位对应源码位置进行小步修正。
:::
