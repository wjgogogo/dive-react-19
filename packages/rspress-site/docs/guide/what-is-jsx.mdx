# ä»€ä¹ˆæ˜¯ JSX ï¼Ÿ

æˆ‘ä»¬ä½¿ç”¨ React æ—¶æœ€å¤§çš„æ„Ÿå—æ˜¯å®ƒè®©å¯ä»¥ç”¨ä¸€ç§æ›´ç›´è§‚ã€æ›´å£°æ˜å¼çš„æ–¹å¼æ¥æè¿°ç”¨æˆ·ç•Œé¢ï¼Œå³ JSXã€‚JSX çš„è¯­æ³•ç±»ä¼¼äº HTMLï¼Œä½†å®ƒå¹¶ä¸æ˜¯ HTMLï¼Œè€Œæ˜¯ JavaScript çš„ä¸€ç§è¯­æ³•æ‰©å±•ã€‚

## JSX çš„æœ¬è´¨

æ—¢ç„¶ JSX å¹¶ä¸æ˜¯æ ‡å‡†çš„ä¸‰å¤§ä»¶ï¼ˆHTMLã€CSSã€JavaScriptï¼‰ï¼Œé‚£ä¹ˆå®ƒå¿…ç„¶éœ€è¦è¢«è½¬æ¢ï¼ˆTransformï¼‰ä¸ºæ ‡å‡†çš„ JavaScript ä»£ç æ‰èƒ½åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚æœ€å¸¸ç”¨çš„è½¬æ¢åŒ…æ‹¬ï¼š

- Babel

```json
// ä½¿ç”¨ @babel/preset-react é¢„è®¾
{
  "presets": ["@babel/preset-react"]
}
```

- TypeScript

```json
// tsconfig.json
{
  "compilerOptions": {
    "jsx": "react"
  }
}
```

- ESBuild

```js
esbuild.build({
  entryPoints: ["app.jsx"],
  bundle: true,
  outfile: "out.js",
  jsx: "transform"
});
```

- SWC (Speedy Web Compiler)ï¼šç”¨ Rust ç¼–å†™çš„å¿«é€Ÿ JavaScript/TypeScript ç¼–è¯‘å™¨ï¼Œæ”¯æŒ JSX è½¬æ¢

```json
// .swcrc
{
  "jsc": {
    "parser": {
      "syntax": "ecmascript",
      "jsx": true
    },
    "transform": {
      "react": {
        "pragma": "React.createElement",
        "pragmaFrag": "React.Fragment"
      }
    }
  }
}
```

### Babel Transform

æœ¬èŠ‚ä»¥ Babel ä¸ºå‡†ï¼Œå…¶ä»–ç¼–è¯‘å™¨å¤„ç†æ–¹å¼ç±»ä¼¼ã€‚

:::info

ä»¥ [@babel/preset-react](https://babeljs.io/docs/babel-preset-react) `v7.26.3` ç‰ˆæœ¬ä¸ºå‡†ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ’ä»¶ï¼š

- [@babel/plugin-transform-react-jsx](https://babeljs.io/docs/babel-plugin-transform-react-jsx)ï¼šç”Ÿäº§ç¯å¢ƒæ‰€ä½¿ç”¨çš„ç¼–è¯‘æ’ä»¶
- [@babel/plugin-transform-react-jsx-development](https://babeljs.io/docs/babel-plugin-transform-react-jsx-development)ï¼šå¼€å‘æ¨¡å¼æ‰€ä½¿ç”¨çš„ç¼–è¯‘æ’ä»¶ï¼Œæä¾›æ›´å¤šå¼€å‘æ‰€éœ€è¦çš„æºç ä¿¡æ¯

> è½¬æ¢è¡Œä¸ºåœ¨æœªæ¥å¯èƒ½ä¼šæ”¹å˜

:::

`@babel/preset-react` åŒ…å«ä¸¤ç§ runtimeï¼š

- `automatic`ï¼šè‡ªåŠ¨é€‰æ‹© runtime
- `classic`ï¼šç»å…¸ runtime

ç›®å‰æ¥è¯´ï¼Œ`automatic` æ˜¯ä¸»æµçš„ runtimeï¼Œæ— éœ€æ‰‹åŠ¨å¼•å…¥ `React`ã€‚

ä»¥å¦‚ä¸‹çš„ä»£ç ä¸ºä¾‹ï¼š

```jsx pure
function Child() {
  return <div>Child</div>;
}
function App() {
  const element = <h1 style={{ color: "red" }}>Hello, world!</h1>;
  console.log("ğŸš€ ~ element:", element);
  return (
    <div>
      {element} <Child />
    </div>
  );
}
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js {4-6,9-14,16-18}
// è‡ªåŠ¨å¼•å…¥ jsx å’Œ jsxs å‡½æ•°
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
function Child() {
  return /*#__PURE__*/ _jsx("div", {
    children: "Child"
  });
}
function App() {
  const element = /*#__PURE__*/ _jsx("h1", {
    style: {
      color: "red"
    },
    children: "Hello, world!"
  });
  console.log("ğŸš€ ~ element:", element);
  return /*#__PURE__*/ _jsxs("div", {
    children: [element, " ", /*#__PURE__*/ _jsx(Child, {})]
  });
}
```

è€Œé‡‡ç”¨çš„ `classic` runtimeï¼Œè¿˜å¿…é¡»æ‰‹åŠ¨å¼•å…¥ `React`ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

```jsx
import React from "react";
```

è½¬æ¢ç»“æœå¦‚ä¸‹ï¼š

```jsx {3,6-14,16-22}
// ä¸ automatic çš„åŒºåˆ«ï¼Œéœ€è¦å¼•å…¥ Reactï¼Œå¦åˆ™ React.createElement ä¼šæŠ¥é”™
function Child() {
  return /*#__PURE__*/ React.createElement("div", null, "Child");
}
function App() {
  const element = /*#__PURE__*/ React.createElement(
    "h1",
    {
      style: {
        color: "red"
      }
    },
    "Hello, world!"
  );
  console.log("ğŸš€ ~ element:", element);
  return /*#__PURE__*/ React.createElement(
    "div",
    null,
    element,
    " ",
    /*#__PURE__*/ React.createElement(Child, null)
  );
}
```

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒæŒ‡å®š `development` ä¸º `true`ï¼Œå¯ä»¥æä¾›å¼€å‘æ‰€éœ€è¦çš„è°ƒè¯•ä¿¡æ¯ã€‚

```json
{
  "presets": [
    [
      "@babel/preset-react",
      {
        "development": true,
        "runtime": "automatic"
      }
    ]
  ]
}
```

ä»£ç è½¬æ¢ç»“æœå¦‚ä¸‹ï¼š

```js {4-17,20-36,38-66}
var _jsxFileName = "xxx.jsx";
import { jsxDEV as _jsxDEV } from "react/jsx-dev-runtime";
function Child() {
  return /*#__PURE__*/ _jsxDEV(
    "div",
    {
      children: "Child"
    },
    void 0,
    false,
    {
      fileName: _jsxFileName,
      lineNumber: 2,
      columnNumber: 10
    },
    this
  );
}
function App() {
  const element = /*#__PURE__*/ _jsxDEV(
    "h1",
    {
      style: {
        color: "red"
      },
      children: "Hello, world!"
    },
    void 0,
    false,
    {
      fileName: _jsxFileName,
      lineNumber: 5,
      columnNumber: 19
    },
    this
  );
  console.log("ğŸš€ ~ element:", element);
  return /*#__PURE__*/ _jsxDEV(
    "div",
    {
      children: [
        element,
        " ",
        /*#__PURE__*/ _jsxDEV(
          Child,
          {},
          void 0,
          false,
          {
            fileName: _jsxFileName,
            lineNumber: 9,
            columnNumber: 17
          },
          this
        )
      ]
    },
    void 0,
    true,
    {
      fileName: _jsxFileName,
      lineNumber: 8,
      columnNumber: 5
    },
    this
  );
}
```

> [babel playground](https://babeljs.io/repl#?browsers=defaults%2C%20not%20ie%2011%2C%20not%20ie_mob%2011&build=&builtIns=false&corejs=3.21&spec=false&loose=false&code_lz=GYVwdgxgLglg9mABAYQBYwDYBMAUBKRAbwChFEAnAUyhHKQB4sYA3APjUy3oHom2BuYgF9ixUJFgJEAQQAOs_EVKIICAM5RElDJQC2lMJoC8ieqgCMiDQE8dRwoRVwMccgC5EAIipZPiIUKsABLaLgA0iADurtgAhDwWrIJkqmBqzpQAdC4A5jiegLwbgAF7iAB-Wjr6hm6eEdp6BlB4yRTUtEg4ymSMLKxdZET1VVBCphzYiNx9A6a8vcrNwkA&debug=false&forceAllTransforms=false&modules=false&shippedProposals=false&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=env%2Creact%2Cstage-2&prettier=true&targets=&version=7.25.8&externalPlugins=&assumptions=%7B%7D)

æ— è®ºæ˜¯ `automatic` è¿˜æ˜¯ `classic`ã€‚æœ¬è´¨éƒ½æ˜¯å°† JSX è½¬æ¢æˆä¸ºå‡½æ•°è°ƒç”¨ï¼Œè€Œå‡½æ•°æ‰§è¡Œåæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ª `ReactElement` çš„æ•°æ®ç»“æ„ã€‚

æ¯”å¦‚ä¸Šé¢çš„ `element` å°±æ˜¯ `ReactElement` çš„æ•°æ®ç»“æ„ï¼Œå¤§æ¦‚é•¿è¿™æ ·ï¼š

![](/react-element.png)

## React 19 å¯¹ JSX çš„å‡çº§

React 19ï¼ˆåŒ…æ‹¬ 18 ï¼‰ å¯¹ JSX çš„[å‡çº§ææ¡ˆ](https://github.com/reactjs/rfcs/pull/107)ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- åºŸå¼ƒ"æ¨¡å—æ¨¡å¼"ç»„ä»¶
- åºŸå¼ƒå‡½æ•°ç»„ä»¶ä¸Šçš„ `defaultProps`
- åºŸå¼ƒä»å¯¹è±¡ä¸­å±•å¼€ `key`
- åºŸå¼ƒå­—ç¬¦ä¸² `refs`ï¼ˆå¹¶ç§»é™¤ç”Ÿäº§æ¨¡å¼çš„ `_owner` å­—æ®µï¼‰
- å°† `ref` æå–ç§»è‡³ç±»ç»„ä»¶ render æ—¶æœºå’Œ `forwardRef` render æ—¶æœº
- å°† `defaultProps` è§£æç§»è‡³ç±»ç»„ä»¶ render æ—¶æœº
- æ›´æ”¹ JSX è½¬è¯‘å™¨ä»¥ä½¿ç”¨æ–°çš„å…ƒç´ åˆ›å»ºæ–¹æ³•
  - å§‹ç»ˆå°† `children` ä½œä¸º props ä¼ é€’
  - å°† `key` ä¸å…¶ä»– props åˆ†å¼€ä¼ é€’
  - åœ¨å¼€å‘ç¯å¢ƒä¸­
    - ä¼ é€’ä¸€ä¸ªæ ‡å¿—æ¥ç¡®å®šæ˜¯å¦ä¸ºé™æ€
    - å°† `__source` å’Œ `__self` ä¸å…¶ä»– props åˆ†å¼€ä¼ é€’

ç›®æ ‡æ˜¯æœ€ç»ˆç§»é™¤å¯¹ `forwardRef` çš„éœ€æ±‚ï¼Œä½¿å…ƒç´ åˆ›å»ºå˜å¾—ç®€å•ï¼š

```js
function jsx(type, props, key) {
  return {
    $$typeof: ReactElementSymbol,
    type,
    key,
    props
  };
}
```

å‡çº§ææ¡ˆéœ€è¦ä¸¤æ–¹é¢çš„é…åˆï¼š

1. Babel å¯¹ JSX å¤„ç†çš„å‡çº§
2. React å¯¹ JSX è½¬æ¢å‡½æ•°çš„é€»è¾‘å‡çº§

### Babel å¯¹ JSX å¤„ç†çš„å‡çº§

#### runtime ä¸º `automatic`

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œå³ï¼šä½¿ç”¨ `@babel/plugin-transform-react-jsx-development`ã€‚ä¼šå°†ç»å¤§éƒ¨åˆ† JSX è½¬æ¢ä¸º `jsxDEV` å‡½æ•°è°ƒç”¨ã€‚

```js
function App() {
  return (
    <h1 key="key" style={{ color: "red" }}>
      title
    </h1>
  );
}
```

```js
// è‡ªåŠ¨å¼•å…¥ jsxDEV å‡½æ•°
import { jsxDEV as _jsxDEV } from "react/jsx-dev-runtime";

const element = /*#__PURE__*/ _jsxDEV(
  "h1",
  {
    style: {
      color: "red"
    },
    children: "title "
  },
  "key",
  false,
  {
    fileName: _jsxFileName,
    lineNumber: 14,
    columnNumber: 15
  },
  this
);
```

`jsxDEV` å‡½æ•°ç±»å‹ï¼š

```ts
type jsxDEV = (
  type,
  config,
  maybeKey,
  isStaticChildren,
  source,
  self
) => ReactElement;
```

æ¥æ”¶ 6 ä¸ªå‚æ•°ï¼š

- `type`ï¼šå…ƒç´ ç±»å‹
- `config`ï¼šå³ props å¯¹è±¡ï¼ŒåŒ…å« `children` ç­‰å±æ€§
- `maybeKey`ï¼šå•ç‹¬å‰¥ç¦»çš„ `key` å±æ€§
- `isStatic`ï¼š`children` æ˜¯å¦ä¸ºé™æ€
- `source`ï¼šæºç ä¿¡æ¯
- `self`ï¼šå½“å‰ç»„ä»¶å®ä¾‹ï¼Œé€šå¸¸ç›´æ¥ä¼ å…¥ `this`ï¼Œåœ¨ç±»ç»„ä»¶æ‰æœ‰æ„ä¹‰

`type` åŒ…å«ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

- å­—ç¬¦ä¸²ï¼šè¡¨ç¤ºåŸç”Ÿ DOM ç»„ä»¶ï¼Œå¦‚ `div`
- å‡½æ•°ï¼šè¡¨ç¤ºç±»ã€å‡½æ•°ç»„ä»¶
- Symbol(æˆ–è€…ç‰¹æ®Šå­—ç¬¦ä¸² polyfillï¼Œä¸»è¦é’ˆå¯¹React å†…ç½®ç»„ä»¶)ï¼šå¦‚ `Fragment`ï¼Œ`StrictMode` ç­‰

Babel ä¼šæ ¹æ® `type` çš„ç±»å‹ï¼Œé€‰æ‹©ä¸åŒçš„è½¬æ¢é€»è¾‘ã€‚å¦‚æœæ˜¯åŸç”Ÿæ ‡ç­¾ï¼ˆä»¥å°å†™å¼€å¤´çš„å­—ç¬¦ä¸²ï¼‰ï¼Œä¼šè½¬æ¢ä¸º `string` ç±»å‹ï¼Œå¦åˆ™ä¿æŒåŸæ ·ã€‚

```js
function App() {
  const element1 = <div />;
  const element2 = <span />;

  const element3 = <Test />;
  const element4 = <component.Test />;

  const element5 = <React.StrictMode></React.StrictMode>;
  const element6 = <></>;
}
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
import {
  jsxDEV as _jsxDEV,
  Fragment as _Fragment
} from "react/jsx-dev-runtime";
function App() {
  const element1 = /*#__PURE__*/ _jsxDEV(
    "div"
    /** ... */
  );
  const element2 = /*#__PURE__*/ _jsxDEV(
    "span"
    /** ... */
  );

  const element3 = /*#__PURE__*/ _jsxDEV(
    Test
    /** ... */
  );
  const element4 = /*#__PURE__*/ _jsxDEV(
    component.Test
    /** ... */
  );

  const element5 = /*#__PURE__*/ _jsxDEV(
    React.StrictMode
    /** ... */
  );
  const element6 = /*#__PURE__*/ _jsxDEV(_Fragment /** ... */);
}
```

:::tip
è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ React å¸Œæœ›ç»„ä»¶å**ä»¥å¤§å†™å­—æ¯å¼€å¤´**ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é¿å…ä¸åŸç”Ÿæ ‡ç­¾æ··æ·†è€Œå¯¼è‡´ Babel è½¬æ¢é”™è¯¯ã€‚
:::

`config` å¯¹è±¡ï¼Œå³ï¼šå¯¹åº” props å±æ€§ï¼Œä¼šå°†é™¤äº† `key` ä¹‹å¤–çš„æ‰€æœ‰å±æ€§æ”¶æ•›åˆ°å…¶ä¸­ï¼ŒåŒ…å« `children` å±æ€§ï¼ˆ_`children` åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¼šè§£æä¸º `jsxDev` å•ç‹¬çš„å‚æ•°_ ï¼‰ã€‚

```js
const element = (
  <h1 key="key" ref={ref} other={other}>
    title
  </h1>
);
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
const element = /*#__PURE__*/ _jsxDEV(
  "h1",
  {
    ref: ref,
    other: other,
    children: "title"
  },
  "key", // key ä¼šè¢«å•ç‹¬æå‡ºæ¥ï¼Œä¾¿äºæé«˜åç»­ React è§£ææ€§èƒ½
  false,
  {
    fileName: _jsxFileName,
    lineNumber: 5,
    columnNumber: 15
  },
  this
);
```

`maybeKey` ç”¨äºå•ç‹¬æå– `key` å±æ€§ï¼Œä¸ºä»€ä¹ˆä¼šå« `maybeKey` å‘¢ï¼Ÿ

æ¯”å¦‚ä»¥ä¸‹åœºæ™¯ï¼š

```js
const element = (
  <h1 key="key" {...props}>
    title
  </h1>
);
```

`props` é‡Œé¢è¯´ä¸å®šæœ¬èº«å°±åŒ…å« `key` å±æ€§ï¼Œè€Œå•çº¯ä»é™æ€åˆ†æï¼ŒBabel æ— æ³•å¾—çŸ¥è¿™ä¸€ç‚¹ã€‚

è™½ç„¶å¦‚æ­¤ï¼Œä¸Šé¢çš„ä»£ç ä¾æ—§ä¼šè¢«è§£ææˆï¼š

```js
const element = /*#__PURE__*/ _jsxDEV(
  "h1",
  {
    ...props,
    children: "title"
  },
  "key",
  false,
  {
    fileName: _jsxFileName,
    lineNumber: 5,
    columnNumber: 15
  },
  this
);
```

:::info
ç°é˜¶æ®µï¼ŒReact ä¼šåœ¨è¿è¡Œæ—¶ä¾æ—§ä» `config` ä¸­è§£æ `key` å±æ€§ï¼Œä½†æ˜¯ä¼šæŠ›å‡º warning ä¿¡æ¯ï¼Œæç¤º `key` åº”è¯¥è¢«å•ç‹¬æŒ‡å®šå‡ºæ¥ã€‚ä¸‹ä¸€æ­¥ï¼ˆ_ä¸èƒ½ç¡®å®šä»€ä¹ˆæ—¶å€™_ï¼‰ä¼šåœæ­¢ä» `config` ä¸­è§£æ `key`
:::

ç°é˜¶æ®µè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼š

> An unresolved issue is how we distinguish `<div key="Hi" {...props} />` from `<div {...props} key="Hi" />` which currently have different semantics depending on if props has a key.

å¦‚æœæ˜¯ï¼š

```js
const element = (
  <h1 {...props} key="key">
    title
  </h1>
);
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
import { createElement as _createElement } from "react";
const element = /*#__PURE__*/ _createElement(
  "h1",
  {
    ...props,
    key: "key",
    __self: this,
    __source: {
      fileName: _jsxFileName,
      lineNumber: 2,
      columnNumber: 15
    }
  },
  "title"
);
```

Babel ä¼šä½¿ç”¨ `React.createElement` æ¥ä»£æ›¿ `jsxDEV` å‡½æ•°ã€‚

:::note
å¯¹è¿™æ ·çš„å¤„ç†ï¼Œç¬”è€…ä¹Ÿæœ‰ç‚¹ç–‘æƒ‘ã€‚æŒ‰ç†è¯´ï¼Œç›¸æ¯”è¾ƒäº`<div key="Hi" {...props} />`, `<div {...props} key="Hi" />` æ›´åº”è¯¥è§£æä¸º`jsxDEV("div",config,"key")`ã€‚

**Babel çš„å¯¹æ­¤çš„ç¼–è¯‘è¡Œä¸ºæœªæ¥å¯èƒ½ä¼šæœ‰æ‰€æ”¹å˜**ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œå°† `key` æ”¾åœ¨å‰é¢ï¼Œé¿å…è§£æä¸º `React.createElement`ï¼Œèƒ½è·å¾—æ›´å¥½æ€§èƒ½ã€‚
:::

`isStatic` ç”¨äºæ ‡è®° `children` æ˜¯å¦ä¸ºé™æ€ã€‚é™æ€æ„å‘³ç€ `children` å­˜åœ¨ï¼Œä¸”**æ•°é‡**æ˜¯å›ºå®šçš„ã€‚æ¯”å¦‚ï¼š

```js
const noChildren = <div />;

const oneChild = <div>Hi</div>;

const multipleChildren = (
  <div>
    <span>Hi</span>
    <span>Hi</span>
  </div>
);

const multipleChildren1 = (
  <div>
    {getChild()}
    {someCondition ? getChild1() : getChild2()}
  </div>
);

const dynamicChildren = (
  <div>
    {items.map((item) => (
      <span key={item.id}>{item.name}</span>
    ))}
  </div>
);
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
const noChildren = /*#__PURE__*/ _jsxDEV(
  "div",
  {},
  void 0,
  false
  /** ... */
);

const oneChild = /*#__PURE__*/ _jsxDEV(
  "div",
  {
    children: "Hi"
  },
  void 0,
  false
  /** ... */
);

const multipleChildren = /*#__PURE__*/ _jsxDEV(
  "div",
  {
    children: [
      /*#__PURE__*/ _jsxDEV(
        "span",
        {
          children: "Hi"
        },
        void 0,
        false
        /** ... */
      ),
      /*#__PURE__*/ _jsxDEV(
        "span",
        {
          children: "Hi"
        },
        void 0,
        false
        /** ... */
      )
    ]
  },
  void 0,
  true
  /** ... */
);
const multipleChildren1 = /*#__PURE__*/ _jsxDEV(
  "div",
  {
    children: [getChild(), someCondition ? getChild1() : getChild2()]
  },
  void 0,
  true
  /** ... */
);
const dynamicChildren = /*#__PURE__*/ _jsxDEV(
  "div",
  {
    children: items.map((item) =>
      /*#__PURE__*/ _jsxDEV(
        "span",
        {
          children: item.name
        },
        item.id,
        false
        /** ... */
      )
    )
  },
  void 0,
  false
  /** ... */
);
```

`isStatic` å’Œ Babel å¯¹`config.children` çš„è§£æç›¸å…³è”ï¼š

- ä¸å­˜åœ¨ `children` æ—¶ï¼Œ`config`ä¸­ä¹Ÿä¸å­˜åœ¨ `children` å±æ€§ï¼Œ`isStatic` ä¸º `false`
- åªå­˜åœ¨ä¸€ä¸ª `children` æ—¶ï¼Œ`config`ä¸­è™½ç„¶å­˜åœ¨ `children` å±æ€§ï¼Œä½†ä¸æ˜¯æ•°ç»„ç±»å‹ï¼Œ`isStatic` ä¸º `false`
- å­˜åœ¨å¤šä¸ª `children` æ—¶ï¼Œ`config`ä¸­å­˜åœ¨ `children` å±æ€§ï¼Œä¸”æ˜¯æ•°ç»„ç±»å‹
  - å¦‚æœ `children` ä¸­ä¸æ˜¯ä»¥`map` å‡½æ•°å½¢å¼å­˜åœ¨ï¼Œæ•°é‡å¯æ•°ï¼Œ`isStatic` ä¸º `true`, å¦åˆ™ `isStatic` ä¸º `false`

ç®€å•æ¥è¯´ï¼Œå½“`config.children`è¢«è§£æä¸ºæ•°ç»„ç±»å‹æ—¶ï¼Œä¸”æ•°é‡æ˜¯é™æ€ï¼Œå¯æ•°çš„ã€‚`isStatic` ä¸º `true`ã€‚

:::note
`isStatic` å±æ€§åä¼šè®©äººè¯¯è§£ä¸ºï¼š`children` æ˜¯å®Œå…¨ä¸å¯å˜çš„ã€‚æ¯”å¦‚ `div>Hi</div>` æˆ–è€… `<div><span color="red"/></div>`è¿™æ ·ï¼Œè€Œä¸æ˜¯åŒ…å«åŠ¨æ€å±æ€§ï¼Œæ¯”å¦‚ `<div>{getChild()}</div>` æˆ–è€… `<div><span color={dynamic}/></div>`ã€‚

ç°é˜¶æ®µï¼ŒBabel ä¸»è¦æ˜¯ä» `children` çš„ä¸ªæ•°æ¥åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€ã€‚
:::

åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œå³ä½¿ç”¨ `@babel/plugin-transform-react-jsx`ã€‚ä¼šå°†ç»å¤§éƒ¨åˆ† JSX è½¬æ¢ä¸º `jsx` æˆ–è€… `jsxs` å‡½æ•°è°ƒç”¨ã€‚

ç±»å‹å¦‚ä¸‹ï¼š

```ts
type jsx = (type, config, maybeKey) => ReactElement;
type jsxs = jsx;
```

ç›¸æ¯”äºå¼€å‘ç¯å¢ƒä¼šå°‘`isStatic`, å’Œ`source`, `self` ç­‰ç”¨äºè°ƒè¯•ä¿¡æ¯çš„å‚æ•°ã€‚

`type`, `config`,`maybeKey`è½¬æ¢æ–¹å¼å’Œå¼€å‘æ¨¡å¼ç±»ä¼¼ï¼Œ`jsx`å’Œ`jsxs`çš„åŒºåˆ«åœ¨äº:

- å¦‚æœåœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œ`isStatic` è¢«è§£æä¸º `true` çš„æƒ…å†µï¼Œç”Ÿäº§æ¨¡å¼ä¼šè½¬æ¢ä¸º `jsxs` å‡½æ•°è°ƒç”¨
- å¦‚æœåœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œ`isStatic` è¢«è§£æä¸º `false` çš„æƒ…å†µï¼Œç”Ÿäº§æ¨¡å¼ä¼šè½¬æ¢ä¸º `jsx` å‡½æ•°è°ƒç”¨

è¿˜æ˜¯ä»¥è¿™æ®µä»£ç ä¸¾ä¾‹ï¼š

```js
const noChildren = <div />;

const oneChild = <div>Hi</div>;

const multipleChildren = (
  <div>
    <span>Hi</span>
    <span>Hi</span>
  </div>
);

const multipleChildren1 = (
  <div>
    {getChild()}
    {someCondition ? getChild1() : getChild2()}
  </div>
);

const dynamicChildren = (
  <div>
    {items.map((item) => (
      <span key={item.id}>{item.name}</span>
    ))}
  </div>
);
```

ä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";

const noChildren = /*#__PURE__*/ _jsx("div", {});

const oneChild = /*#__PURE__*/ _jsx("div", {
  children: "Hi"
});

const multipleChildren = /*#__PURE__*/ _jsxs("div", {
  children: [
    /*#__PURE__*/ _jsx("span", {
      children: "Hi"
    }),
    /*#__PURE__*/ _jsx("span", {
      children: "Hi"
    })
  ]
});

const multipleChildren1 = /*#__PURE__*/ _jsxs("div", {
  children: [getChild(), someCondition ? getChild1() : getChild2()]
});

const dynamicChildren = /*#__PURE__*/ _jsx("div", {
  children: items.map((item) =>
    /*#__PURE__*/ _jsx(
      "span",
      {
        children: item.name
      },
      item.id
    )
  )
});
```

:::info
ä¸Šæ–‡æåˆ°çš„å¼€å‘æ¨¡å¼ä¸­ï¼Œä¼šå°†`<div {...props} key="Hi" />` è½¬æ¢ä¸º `React.createElement` çš„è¡Œä¸ºã€‚åœ¨ç”Ÿäº§æ¨¡å¼ä¾æ—§å­˜åœ¨ã€‚
:::

#### runtime ä¸º `classic`

å½“ runtime ä¸º `classic` æ—¶ï¼Œæ— è®ºæ˜¯å¼€å‘æ¨¡å¼ï¼Œè¿˜æ˜¯ç”Ÿäº§æ¨¡å¼ï¼Œ**æ‰€æœ‰çš„ JSX éƒ½ä¼šè½¬æ¢ `React.createElement` å‡½æ•°**ã€‚

`React.createElement` ç±»å‹ï¼š

```ts
type createElement = (type, config, children) => ReactElement;
```

- `type` è½¬æ¢æ–¹å¼å’Œ `runtime` ä¸º `automatic` æ—¶ä¸€è‡´
- `config` ä¸­åŒ…å«é™¤ `children` çš„æ‰€æœ‰ propsï¼ŒåŒ…å« `key`ï¼Œ`ref`
  - `children` ä¼šè¢«å•ç‹¬æå‡ºæ¥ï¼Œä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹ï¼Œå¹³é“ºä¼ å…¥ï¼Œåç»­çš„å…¥å‚éƒ½ä¼šè¢«è§†ä¸ºæ˜¯ `children` çš„ä¸€é¡¹

æ¯”å¦‚ï¼š

```js
import React from "react";

function Child() {
  return <div>Child</div>;
}

function App() {
  const element = (
    <h1 key={"key"} style={{ color: "red" }} {...props}>
      Hello, world!
    </h1>
  );

  return (
    <div {...props} key={"key"}>
      {element} <Child />
    </div>
  );
}
```

å¼€å‘æ¨¡å¼ä¸‹ï¼Œä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
function _extends() {
  return (
    (_extends = Object.assign
      ? Object.assign.bind()
      : function (n) {
          for (var e = 1; e < arguments.length; e++) {
            var t = arguments[e];
            for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]);
          }
          return n;
        }),
    _extends.apply(null, arguments)
  );
}

import React from "react";

function Child() {
  return /*#__PURE__*/ React.createElement(
    "div",
    {
      __self: this,
      __source: {
        fileName: _jsxFileName,
        lineNumber: 13,
        columnNumber: 10
      }
    },
    "Child"
  );
}

function App() {
  const element = /*#__PURE__*/ React.createElement(
    "h1",
    _extends(
      {
        key: "key",
        style: {
          color: "red"
        }
      },
      props,
      {
        __self: this,
        __source: {
          fileName: _jsxFileName,
          lineNumber: 17,
          columnNumber: 5
        }
      }
    ),
    "Hello, world!"
  );
  return /*#__PURE__*/ React.createElement(
    "div",
    _extends({}, props, {
      key: "key",
      __self: this,
      __source: {
        fileName: _jsxFileName,
        lineNumber: 23,
        columnNumber: 5
      }
    }),
    // ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹ï¼Œåç»­çš„å…¥å‚éƒ½ä¼šè¢«è§†ä¸ºæ˜¯ children çš„ä¸€é¡¹
    element,
    " ",
    /*#__PURE__*/ React.createElement(Child, {
      __self: this,
      __source: {
        fileName: _jsxFileName,
        lineNumber: 24,
        columnNumber: 17
      }
    })
  );
}
```

ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œä¼šè¢«è½¬æ¢ä¸ºï¼š

```js
function _extends() {
  return (
    (_extends = Object.assign
      ? Object.assign.bind()
      : function (n) {
          for (var e = 1; e < arguments.length; e++) {
            var t = arguments[e];
            for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]);
          }
          return n;
        }),
    _extends.apply(null, arguments)
  );
}

import React from "react";

function Child() {
  return /*#__PURE__*/ React.createElement("div", null, "Child");
}

function App() {
  const element = /*#__PURE__*/ React.createElement(
    "h1",
    _extends(
      {
        key: "key",
        style: {
          color: "red"
        }
      },
      props
    ),
    "Hello, world!"
  );
  return /*#__PURE__*/ React.createElement(
    "div",
    _extends({}, props, {
      key: "key"
    }),
    // ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹ï¼Œåç»­çš„å…¥å‚éƒ½ä¼šè¢«è§†ä¸ºæ˜¯ children çš„ä¸€é¡¹
    element,
    " ",
    /*#__PURE__*/ React.createElement(Child, null)
  );
}
```

å¼€å‘æ¨¡å¼ç›¸æ¯”äºç”Ÿäº§æ¨¡å¼ï¼Œä¹Ÿä»…ä»…å¤šäº†ä¸€äº›è°ƒè¯•ä¿¡æ¯ï¼Œæ¯”å¦‚ `config.__self`, `config.__source`ã€‚

### React å¯¹ JSX è½¬æ¢å‡½æ•°çš„é€»è¾‘å‡çº§

#### jsxDEV å‡½æ•°

å…ˆä»æœ€å¤æ‚å¼€å‘æ¨¡å¼ä¸‹çš„ runtime ä¸º `automatic` çš„æƒ…å†µå¼€å§‹ã€‚ä»ä¸Šå¯çŸ¥ï¼ŒJSX ä¼šè¢«è½¬æ¢æˆ`jsxDEV` å‡½æ•°è°ƒç”¨ã€‚

`jsxDEV` æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

1. ç±»å‹æ£€æŸ¥ï¼š
   - éªŒè¯ JSX å…ƒç´ çš„ç±»å‹æ˜¯å¦æœ‰æ•ˆ
   - å¦‚æœç±»å‹æ— æ•ˆï¼Œä¼šç»™å‡ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
2. å­å…ƒç´ å¤„ç†ï¼š
   - éªŒè¯å­å…ƒç´ çš„ key å±æ€§
   - å¤„ç†é™æ€å­å…ƒç´ å’ŒåŠ¨æ€å­å…ƒç´ 
3. å±æ€§å¤„ç†ï¼š
   - å¤„ç† key å’Œ ref å±æ€§
   - è­¦å‘Šä¸æ­£ç¡®çš„ key ä½¿ç”¨æ–¹å¼
   - åˆ›å»º props å¯¹è±¡ï¼Œç§»é™¤ä¿ç•™å±æ€§ï¼ˆå¦‚ key å’Œ refï¼‰
4. é»˜è®¤å±æ€§å¤„ç†ï¼š
   - å¦‚æœç»„ä»¶æœ‰ defaultPropsï¼Œä¸ä¼šå†å°†å…¶åˆå¹¶åˆ° props ä¸­
   - ç±»ç»„ä»¶ä¼šåœ¨ render é˜¶æ®µæ‰çœŸæ­£çš„å¤„ç† defaultProps
5. åˆ›å»º React å…ƒç´ ï¼š
   - æœ€åè°ƒç”¨ ReactElement å‡½æ•°åˆ›å»º React å…ƒç´ 

:::info
`jsxDEV` å‡½æ•°ä»£ç ä¸­åŒ…å«è®¸å¤šä»…åœ¨å¼€å‘ç¯å¢ƒï¼ˆ**DEV**ï¼‰ä¸‹è¿è¡Œçš„æ£€æŸ¥å’Œè­¦å‘Šã€‚è¿™äº›æ£€æŸ¥ç”¨äºå¸®åŠ©å¼€å‘è€…å‘ç°æ½œåœ¨çš„é—®é¢˜ï¼Œå¦‚ç±»å‹é”™è¯¯ã€key ä½¿ç”¨ä¸å½“ç­‰ã€‚

**ä¸‹æ–¹ç»™å‡ºçš„æºç ä¸­åªä¼šä¿ç•™ç›¸å¯¹é‡è¦çš„ä¸»é“¾è·¯é€»è¾‘ï¼Œçœç•¥äº†éƒ¨åˆ†æ ¡éªŒçš„é€»è¾‘**
:::

```js title="react/packages/react/src/jsx/ReactJSXElement.js" {}
/**
 * JSX è½¬æ¢çš„å…¥å£å‡½æ•°ï¼Œå®ƒè°ƒç”¨ jsxDEVImpl æ¥å®é™…å¤„ç† JSX è½¬æ¢
 *
 * https://github.com/reactjs/rfcs/pull/107
 */
export function jsxDEV(type, config, maybeKey, isStaticChildren, source, self) {
  return jsxDEVImpl(
    type,
    config,
    maybeKey,
    isStaticChildren,
    source,
    self,
    // å¼€å‘ç¯å¢ƒä¸‹çš„ç‰¹æ€§å¼€å…³ï¼Œä¸»è¦ç”¨äºè·å–é”™è¯¯å †æ ˆå’Œä¼˜åŒ–å¼‚æ­¥è°ƒç”¨æ ˆçš„ debug
    __DEV__ && enableOwnerStacks ? Error("react-stack-top-frame") : undefined,
    __DEV__ && enableOwnerStacks ? createTask(getTaskName(type)) : undefined
  );
}

function jsxDEVImpl(
  type,
  config,
  maybeKey,
  isStaticChildren,
  source,
  self,
  debugStack,
  debugTask
) {
  if (__DEV__) {
    /**
     * ğŸš§ çœç•¥æ‰å¯¹ typeï¼Œchildren key çš„æ£€æŸ¥å’Œè­¦å‘Š ğŸš§
     */

    // ç°é˜¶æ®µï¼Œä¾æ—§ä¼šä» config ä¸­è·å– key å€¼ï¼Œä½†æ˜¯ä¸ºä¸‹ä¸€é˜¶æ®µåšå‡†å¤‡ï¼Œä¼šè­¦å‘Š key ä½¿ç”¨ä¸å½“

    // Warn about key spread regardless of whether the type is valid.
    if (hasOwnProperty.call(config, "key")) {
      const componentName = getComponentNameFromType(type);
      const keys = Object.keys(config).filter((k) => k !== "key");
      const beforeExample =
        keys.length > 0
          ? "{key: someKey, " + keys.join(": ..., ") + ": ...}"
          : "{key: someKey}";
      if (!didWarnAboutKeySpread[componentName + beforeExample]) {
        const afterExample =
          keys.length > 0 ? "{" + keys.join(": ..., ") + ": ...}" : "{}";
        console.error(
          'A props object containing a "key" prop is being spread into JSX:\n' +
            "  let props = %s;\n" +
            "  <%s {...props} />\n" +
            "React keys must be passed directly to JSX without using spread:\n" +
            "  let props = %s;\n" +
            "  <%s key={someKey} {...props} />",
          beforeExample,
          componentName,
          afterExample,
          componentName
        );
        didWarnAboutKeySpread[componentName + beforeExample] = true;
      }
    }

    let key = null;

    // ä¸‹é¢æ³¨é‡Šæåˆ°äº†å¯¹ <div {...props} key="Hi" or <div key="Hi" {...props} /> ä¸¤ç§æƒ…å†µçš„å¤„ç†è¿˜æœ‰ç‚¹é—®é¢˜

    // Currently, key can be spread in as a prop. This causes a potential
    // issue if key is also explicitly declared (ie. <div {...props} key="Hi" />
    // or <div key="Hi" {...props} /> ). We want to deprecate key spread,
    // but as an intermediary step, we will use jsxDEV for everything except
    // <div {...props} key="Hi" />, because we aren't currently able to tell if
    // key is explicitly declared to be undefined or not.
    if (maybeKey !== undefined) {
      if (__DEV__) {
        checkKeyStringCoercion(maybeKey);
      }
      key = "" + maybeKey;
    }
    // ä¾æ—§ä¼šä» config ä¸­è·å– key å€¼
    if (hasValidKey(config)) {
      if (__DEV__) {
        checkKeyStringCoercion(config.key);
      }
      key = "" + config.key;
    }

    let props;
    if (!("key" in config)) {
      // æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼Œå°½å¯èƒ½é‡ç”¨åŸå§‹çš„ props å¯¹è±¡

      // If key was not spread in, we can reuse the original props object. This
      // only works for `jsx`, not `createElement`, because `jsx` is a compiler
      // target and the compiler always passes a new object. For `createElement`,
      // we can't assume a new object is passed every time because it can be
      // called manually.
      //
      // Spreading key is a warning in dev. In a future release, we will not
      // remove a spread key from the props object. (But we'll still warn.) We'll
      // always pass the object straight through.
      props = config;
    } else {
      // We need to remove reserved props (key, prop, ref). Create a fresh props
      // object and copy over all the non-reserved props. We don't use `delete`
      // because in V8 it will deopt the object to dictionary mode.
      props = {};
      for (const propName in config) {
        // Skip over reserved prop names
        // ä¸ä¼šå¯¹ ref åšç‰¹æ®Šå¤„ç†ï¼Œæ‰€ä»¥ ref ä¸ä¼šå†ä½œä¸ºä¿ç•™å±æ€§ï¼Œè€Œæ˜¯ä¼šä¿ç•™åœ¨ props ä¸­
        if (propName !== "key") {
          props[propName] = config[propName];
        }
      }
    }

    // åœ¨ 19 ä¸­ï¼ŒdisableDefaultPropsExceptForClasses ä¸º true
    // æ‰€ä»¥ä¸ä¼šå†å°† defaultProps åˆå¹¶åˆ° props ä¸­
    if (!disableDefaultPropsExceptForClasses) {
      // Resolve default props
      if (type && type.defaultProps) {
        const defaultProps = type.defaultProps;
        for (const propName in defaultProps) {
          if (props[propName] === undefined) {
            props[propName] = defaultProps[propName];
          }
        }
      }
    }

    // å¯¹ä» props ä¸­è·å–çš„ key åšç‰¹æ®Šå¤„ç†ï¼Œæ·»åŠ å¼€å‘ç¯å¢ƒè­¦å‘Š
    if (key) {
      const displayName =
        typeof type === "function"
          ? type.displayName || type.name || "Unknown"
          : type;
      defineKeyPropWarningGetter(props, displayName);
    }

    // æœ€åè°ƒç”¨ ReactElement å‡½æ•°åˆ›å»º React å…ƒç´ 
    return ReactElement(
      type,
      key,
      self,
      source,
      getOwner(),
      props,
      debugStack,
      debugTask
    );
  }
}
```

```js title="react/packages/react/src/jsx/ReactJSXElement.js"
function ReactElement(
  type,
  key,
  self,
  source,
  owner,
  props,
  debugStack,
  debugTask
) {
  // When enableRefAsProp is on, ignore whatever was passed as the ref
  // argument and treat `props.ref` as the source of truth. The only thing we
  // use this for is `element.ref`, which will log a deprecation warning on
  // access. In the next release, we can remove `element.ref` as well as the
  // `ref` argument.
  const refProp = props.ref;

  // An undefined `element.ref` is coerced to `null` for
  // backwards compatibility.
  const ref = refProp !== undefined ? refProp : null;

  // åˆ†ä¸åŒçš„æƒ…å†µæ„å»º elementï¼Œä¸»è¦åŒºåˆ«åœ¨äº ref çš„å¤„ç†
  let element;
  if (__DEV__) {
    // In dev, make `ref` a non-enumerable property with a warning. It's non-
    // enumerable so that test matchers and serializers don't access it and
    // trigger the warning.
    //
    // `ref` will be removed from the element completely in a future release.
    element = {
      // This tag allows us to uniquely identify this as a React Element
      $$typeof: REACT_ELEMENT_TYPE,

      // Built-in properties that belong on the element
      type,
      key,

      props,

      // Record the component responsible for creating this element.
      _owner: owner
    };
    // å¯¹ ref åšç‰¹æ®Šå¤„ç†ï¼Œæ·»åŠ å¼€å‘ç¯å¢ƒè­¦å‘Š
    if (ref !== null) {
      Object.defineProperty(element, "ref", {
        enumerable: false,
        get: elementRefGetterWithDeprecationWarning
      });
    } else {
      // Don't warn on access if a ref is not given. This reduces false
      // positives in cases where a test serializer uses
      // getOwnPropertyDescriptors to compare objects, like Jest does, which is
      // a problem because it bypasses non-enumerability.
      //
      // So unfortunately this will trigger a false positive warning in Jest
      // when the diff is printed:
      //
      //   expect(<div ref={ref} />).toEqual(<span ref={ref} />);
      //
      // A bit sketchy, but this is what we've done for the `props.key` and
      // `props.ref` accessors for years, which implies it will be good enough
      // for `element.ref`, too. Let's see if anyone complains.
      Object.defineProperty(element, "ref", {
        enumerable: false,
        value: null
      });
    }
  } else {
    // In prod, `ref` is a regular property and _owner doesn't exist.
    element = {
      // This tag allows us to uniquely identify this as a React Element
      $$typeof: REACT_ELEMENT_TYPE,

      // Built-in properties that belong on the element
      type,
      key,
      ref,

      props
    };
  }

  /**
   * ğŸš§ çœç•¥æ‰å¯¹ element çš„å¼€å‘æ—¶ debug å±æ€§çš„å¤„ç† ğŸš§
   */

  return element;
}
```

ç»è¿‡ä¸Šé¢çš„æµç¨‹ï¼Œå‡½æ•°`jsxDEV` å°†ç¼–è¯‘å JSX å¯¹è±¡è½¬æ¢ä¸º ReactElement å…ƒç´ ï¼Œè¿™ä¸ªå…ƒç´ æ˜¯ React å†…éƒ¨ç”¨äºæè¿°ç»„ä»¶æ ‘çš„èŠ‚ç‚¹ï¼Œä½œä¸º React æ¸²æŸ“å’Œæ›´æ–°æœºåˆ¶çš„è¾“å…¥ã€‚

##### æ€§èƒ½æå‡

Babel ä¼šå°† JSX çš„ props ä½¿ç”¨ä¸€ä¸ªæ–°çš„å¯¹è±¡æ¥æ‰¿è½½ï¼Œ_åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œ`jsxDEV` æ€»æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç”¨äºæ‰¿è½½å‰”é™¤æ‰ `ref`ï¼Œ`key`ç­‰ä¿ç•™å±æ€§_ï¼Œ**è€Œç°åœ¨ï¼Œä¼šå°½å¯èƒ½é‡ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œä»¥å‡å°‘å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶çš„è´Ÿæ‹…**ã€‚

:::details æ€§èƒ½é—®é¢˜
![](/jsx-performance-issue.png)

> https://github.com/reactjs/rfcs/pull/107#issuecomment-1709063073

:::

ç”Ÿäº§æ¨¡å¼ä¸‹çš„ `jsx` & `jsxs` å‡½æ•°æœ¬è´¨å°±æ˜¯`jsxProd` å‡½æ•°ï¼Œå³ `jsxDEV` å‡½æ•°å»é™¤äº†æ ¡éªŒé€»è¾‘çš„ç‰ˆæœ¬ï¼Œä¸å†èµ˜è¿°ã€‚

:::tip
ReactElement å…ƒç´  å’Œ Fiber èŠ‚ç‚¹æ˜¯ä¸åŒçš„ï¼Œåæ–‡ä¼šè¯¦è§£ä»‹ç» Fiber èŠ‚ç‚¹ï¼Œæ³¨æ„ä¸è¦æ··æ·†ã€‚
:::

#### createElement å‡½æ•°

ä¸Šæ–‡æåˆ° `automatic` æ¨¡å¼ä¸‹æœ‰äº›ç‰¹æ®Šæƒ…å†µï¼Œæˆ–è€…æ˜¯ `classic` æ¨¡å¼ä¸‹ï¼ŒJSX ä¼šè¢«è½¬æ¢æˆ `createElement` å‡½æ•°è°ƒç”¨ã€‚

ä¸‹é¢æ¥çœ‹ä¸‹ `createElement` å‡½æ•°çš„å®ç°ã€‚

```js title="react/packages/react/src/jsx/ReactJSXElement.js"
export function createElement(type, config, children) {
  /**
   * ğŸš§ çœç•¥æ‰å¯¹ typeï¼Œchildren key çš„æ£€æŸ¥å’Œè­¦å‘Š ğŸš§
   */

  let propName;

  // Reserved names are extracted
  const props = {};

  let key = null;

  // config ä¸­åŒ…å«é™¤ children çš„æ‰€æœ‰ propsï¼ŒåŒ…å« keyï¼Œref
  if (config != null) {
    if (__DEV__) {
      // å¯¹æ—§çš„ JSX è½¬æ¢åšè­¦å‘Š
      if (
        !didWarnAboutOldJSXRuntime &&
        "__self" in config &&
        // Do not assume this is the result of an oudated JSX transform if key
        // is present, because the modern JSX transform sometimes outputs
        // createElement to preserve precedence between a static key and a
        // spread key. To avoid false positive warnings, we never warn if
        // there's a key.
        !("key" in config)
      ) {
        didWarnAboutOldJSXRuntime = true;
        console.warn(
          "Your app (or one of its dependencies) is using an outdated JSX " +
            "transform. Update to the modern JSX transform for " +
            "faster performance: https://react.dev/link/new-jsx-transform"
        );
      }
    }

    if (hasValidKey(config)) {
      if (__DEV__) {
        checkKeyStringCoercion(config.key);
      }
      key = "" + config.key;
    }

    // å°† config ä¸­é™¤ key ä¹‹å¤–çš„å±æ€§æ·»åŠ åˆ° props å¯¹è±¡ä¸­ï¼Œç”±äºæ¯æ¬¡éƒ½ä¼šæ„å»ºæ–°çš„ props å¯¹è±¡ï¼Œæ€§èƒ½ä¼šå·®ç‚¹

    // Remaining properties are added to a new props object
    for (propName in config) {
      if (
        hasOwnProperty.call(config, propName) &&
        // Skip over reserved prop names
        propName !== "key" &&
        // Even though we don't use these anymore in the runtime, we don't want
        // them to appear as props, so in createElement we filter them out.
        // We don't have to do this in the jsx() runtime because the jsx()
        // transform never passed these as props; it used separate arguments.
        propName !== "__self" &&
        propName !== "__source"
      ) {
        props[propName] = config[propName];
      }
    }
  }

  // ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹ï¼Œåç»­çš„å…¥å‚éƒ½ä¼šè¢«è§†ä¸ºæ˜¯ children çš„ä¸€é¡¹ï¼Œå°†å…¶æ”¶æ•›åˆ° props å±æ€§ä¸­

  // Children can be more than one argument, and those are transferred onto
  // the newly allocated props object.
  const childrenLength = arguments.length - 2;
  if (childrenLength === 1) {
    props.children = children;
  } else if (childrenLength > 1) {
    const childArray = Array(childrenLength);
    for (let i = 0; i < childrenLength; i++) {
      childArray[i] = arguments[i + 2];
    }
    if (__DEV__) {
      if (Object.freeze) {
        Object.freeze(childArray);
      }
    }
    props.children = childArray;
  }

  // ä¸ jsxDEV ä¸åŒçš„æ˜¯ï¼Œå°‘äº†ç‰¹æ€§å¼€å…³ï¼Œæ‰€ä»¥ç»„ä»¶çš„ defaultPropsï¼Œæ€»æ˜¯ä¼šè¢«åˆå¹¶åˆ° props ä¸­

  // Resolve default props
  if (type && type.defaultProps) {
    const defaultProps = type.defaultProps;
    for (propName in defaultProps) {
      if (props[propName] === undefined) {
        props[propName] = defaultProps[propName];
      }
    }
  }
  if (__DEV__) {
    if (key) {
      const displayName =
        typeof type === "function"
          ? type.displayName || type.name || "Unknown"
          : type;
      defineKeyPropWarningGetter(props, displayName);
    }
  }

  return ReactElement(
    type,
    key,
    undefined,
    undefined,
    getOwner(),
    props,
    __DEV__ && enableOwnerStacks ? Error("react-stack-top-frame") : undefined,
    __DEV__ && enableOwnerStacks ? createTask(getTaskName(type)) : undefined
  );
}
```

:::tip
æˆ‘ä»¬å¯èƒ½å¶å°”ä¹Ÿä¼šç”¨åˆ° [`React.cloneElement`](https://react.dev/reference/react/cloneElement) å‡½æ•°ï¼Œå®ƒä¸»è¦ç”¨äºå…‹éš† ReactElement å…ƒç´ ï¼Œå¹¶è¿›è¡Œä¸€äº›æ‰©å±•ã€‚æ ¸å¿ƒä»£ç æµç¨‹å’Œ `React.createElement` å‡½æ•°å¤§è‡´ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚
:::

> å‚è€ƒ
>
> - [RFC: createElement changes and surrounding deprecations](https://github.com/reactjs/rfcs/pull/107)
> - [create-element-changes](https://github.com/reactjs/rfcs/blob/createlement-rfc/text/0000-create-element-changes.md)
